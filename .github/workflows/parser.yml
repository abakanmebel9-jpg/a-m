name: Telegram Channel Parser

on:
  schedule:
    - cron: '0 */6 * * *'  # Запуск каждые 6 часов
  workflow_dispatch:        # Ручной запуск из интерфейса GitHub

jobs:
  parse-and-cache:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Trigger Cloudflare Worker
        env:
          CF_WORKER_URL: ${{ secrets.CF_WORKER_URL }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          echo "Запуск парсера через Cloudflare Worker..."
          RESPONSE=$(curl -s -X POST "$CF_WORKER_URL/parse" \
            -H "Authorization: Bearer $CF_API_TOKEN")
          
          echo "Ответ Worker: $RESPONSE"
          
          # Проверка успешности выполнения
          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "✅ Парсинг успешно завершен."
          else
            echo "❌ Ошибка при парсинге."
            exit 1
          fi

      - name: Verify cache update
        if: success()
        env:
          CF_WORKER_URL: ${{ secrets.CF_WORKER_URL }}
        run: |
          echo "Проверка обновления кэша..."
          curl -s "$CF_WORKER_URL/last-update"
