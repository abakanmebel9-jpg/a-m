name: Telegram Parser

on:
  schedule:
    - cron: '*/5 * * * *'  # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  workflow_dispatch:        # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches: [ main ]

jobs:
  parse:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 lxml

    - name: Create data directory
      run: mkdir -p data

    - name: Run parser script
      run: |
        cat > parse.py << 'EOF'
import requests
import json
from datetime import datetime
import re

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
CHANNEL = "abakan_mebel"
MAX_POSTS = 100

def fetch_telegram():
    """–ü–æ–ª—É—á–∞–µ–º HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–Ω–∞–ª–∞"""
    url = f"https://t.me/s/{CHANNEL}"
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    }
    
    try:
        response = requests.get(url, headers=headers, timeout=30)
        response.raise_for_status()
        return response.text
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}")
        return None

def parse_html(html):
    """–ü–∞—Ä—Å–∏–º HTML –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –ø–æ—Å—Ç—ã"""
    posts = []
    
    if not html:
        # –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∞
        for i in range(5):
            posts.append({
                'id': f'demo_{i}',
                'text': f'–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç #{i+1} –¥–ª—è abakan_mebel. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä—Å–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.',
                'date': datetime.now().isoformat(),
                'timestamp': int(datetime.now().timestamp()) - i*3600
            })
        return posts
    
    # –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ Telegram
    # –ò—â–µ–º –±–ª–æ–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    message_pattern = r'<div class="tgme_widget_message[^>]*>'
    messages = re.split(message_pattern, html)[1:11]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 10
    
    for i, msg in enumerate(messages[:MAX_POSTS]):
        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º ID
            id_match = re.search(r'data-post="([^"]+)"', msg)
            post_id = id_match.group(1).split('/')[-1] if id_match else f"msg_{i}"
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç
            text_match = re.search(r'<div class="tgme_widget_message_text[^>]*>(.*?)</div>', msg, re.DOTALL)
            text = text_match.group(1).strip() if text_match else f"–°–æ–æ–±—â–µ–Ω–∏–µ {i+1}"
            
            # –û—á–∏—â–∞–µ–º HTML —Ç–µ–≥–∏
            text = re.sub(r'<[^>]+>', '', text)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É
            date_match = re.search(r'<time[^>]*datetime="([^"]+)"', msg)
            date_str = date_match.group(1) if date_match else datetime.now().isoformat()
            
            posts.append({
                'id': post_id,
                'text': text[:500],  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
                'date': date_str,
                'timestamp': int(datetime.now().timestamp()) - i*60,
                'source': 'telegram'
            })
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è {i}: {e}")
            continue
    
    return posts

def main():
    print("=== –ü–∞—Ä—Å–∏–Ω–≥ Telegram –∫–∞–Ω–∞–ª–∞ ===")
    print(f"–ö–∞–Ω–∞–ª: {CHANNEL}")
    print(f"–ú–∞–∫—Å–∏–º—É–º –ø–æ—Å—Ç–æ–≤: {MAX_POSTS}")
    
    # –ü–æ–ª—É—á–∞–µ–º HTML
    html = fetch_telegram()
    
    # –ü–∞—Ä—Å–∏–º –ø–æ—Å—Ç—ã
    posts = parse_html(html)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
    data = {
        'channel': CHANNEL,
        'updated_at': datetime.now().isoformat(),
        'post_count': len(posts),
        'max_posts': MAX_POSTS,
        'posts': posts
    }
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
    with open('data/posts.json', 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    
    print(f"‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø–æ—Å—Ç–æ–≤: {len(posts)}")
    print(f"‚úì –§–∞–π–ª: data/posts.json")
    
    # –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = {
        'total_posts': len(posts),
        'last_update': datetime.now().isoformat(),
        'channel': CHANNEL,
        'average_length': sum(len(p['text']) for p in posts) / len(posts) if posts else 0
    }
    
    with open('data/stats.json', 'w', encoding='utf-8') as f:
        json.dump(stats, f, ensure_ascii=False, indent=2)
    
    print("‚úì –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞")

if __name__ == "__main__":
    main()
EOF
        python parse.py

    - name: Commit and push changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add data/
        if git diff --cached --quiet; then
          echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin main
        fi
